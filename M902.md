# MÓDULO 9. FUSIONES DE TRES VÍAS

> MANEJO DE ARCHIVOS MODIFICADOS Y COLABORACIÓN 

## 1. Resultado con conflicto

Algunas veces, Git no puede decidir cuál línea conservar. Por lo que creará un archivo fusionado con conflictos:

```git
<<<<<<< HEAD
Cambio en main
=======
Cambio en experimento
>>>>>>> experimento
```

Entonces, este el archivo en disputa (dos ramas intentan modificar el mismo archivo generando colisiones de código), tiene tres posibles desenlaces:

1. Conservar el cambio actual: Respeta solo el código de la rama actual
2. Conservar el cambio entrante: Respeta solo el código de la rama entrante (a fusionar)
3. Conservar ambos cambios: Se tiene que determinar cómo conservar ambos resultados (requiere un experto que los fusione)

## 2. Resolución del conflicto

Para resolver el conflicto, basta con editar el archivo y dejar un código limpio entre ambas versiones (de la rama actual y de la rama entrante).

Esto parece trival, pero muchas veces tendremos que el experto en el código (los dos desarrolladores involucrados de cada rama) determinen cómo quedaría la fusión para que funcione.

Al editar el archivo y fusionar una única versión, basta con hacer un *commit* guardando la versión fusionada.

En este punto, el conflicto ya estará resuelto.

> ¿Qué pasa si no sé resolver la fusión?

Podemos abortar el **merge** y decirle al programador que el se fusione a la rama actual para que el resuelva el conflicto, delegando así la responsabilidad de fusionar nostros la rama entrante.

Una vez que el desarrollador resulva el conflicto en su rama, ambos tendremos el mismo **HEAD**, por lo que podremos fusionar su rama a nuestra rama.

Algoritmo de resolución del conflicto:

1. En la rama `A` se intenta fusionar la rama `B` (en la rama `A` se hace `git merge B`)
2. Surge un conflicto en los archivos `x`, `y` y `z`
3. Para cada archivo, se modifica la parte en conflicto (quitar los marcadores `<<<<<HEAD`, `=====` y `>>>>>`)
4. Hacer un *commit* con los archivos fusionados

En caso de que se quiera abortar el conflicto debemos hacer:

```bash
git merge --abort
```

Esto cancelará la fusión de la rama y los archivos volverán a su estado original para la rama actual (rama `A`).

**Observación:** Cuando no hay colisión de líneas de código entre los archivos, la fusión es automática y se respetan ambas partes, esto puede ser peligroso si un programador define código que se fusione con otro código sin colisión, pero ambos hagan que no compile (por ejemplo, definen la misma función en lugares distintos dentro del mismo archivo). Por lo que una buena práctica es compilar o revisar bien los códigos tras cada fusión y no solo darlos por buenos.

## 3. Estrategias de fusión (opcional)

Podemos opcionalmente darle prioridad a la rama entrante (`theirs`) o a la rama actual (`ours`) al hacer el **merge**:

```bash
git merge -s recursive -X theirs rama-remota
```

* `-X theirs`: prioriza los cambios de la rama que se fusiona.
* `-X ours`: prioriza tu rama actual (*HEAD*).

**IMPORTANTE:** Útil para casos automatizados, aunque no se recomienda abusar de estas opciones sin revisar los cambios.

## 4. Flujo de colaboración recomendado

1. Cada colaborador trabaja en su rama (`dev/<nombre>` o `feature/<tag>`)
2. Hacen **pull** y **merge** de `dev` o `dev/main` frecuentemente (por ejemplo, al principio de una etapa)
3. Hacen **push** de su rama a *origin* (su rama remota)
4. Un integrador realiza el **merge** a `dev/main` o `dev` y resuelve conflictos (por ejemplo, al final de una etapa)

## 5. Buenas prácticas

* Hacer `pull` frecuente para evitar divergencias largas (al principio de cada etapa).
* Resolver conflictos con editores que marquen visualmente las secciones.
* No hacer `merge` a *main* sin revisión o pruebas.

## 6. Comandos principales

Comando | Descripción
--- | ---
`git merge <rama>` | Fusiona la rama especificada con la actual
`git diff` | Muestra diferencias antes o después de una fusión
`git status` | Muestra archivos en conflicto
`git add <archivo>` | Marca como resuelto un archivo en conflicto
`git commit` | Finaliza la fusión después de resolver los conflictos
`git merge --abort` | Cancela la fusión en curso si aún no se resolvió